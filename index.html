// ====================== KONFIG ======================
const COLORS=["#ff004c","#00e5ff","#ffee00","#00ff6a","#a855ff","#ff8c00","#00ffcc","#ff5ea8"];
const LEVELS={ easy:[3,2], medium:[4,3,2], hard:[5,4,3,2], extreme:[6,5,4,3], pro:[7,6,5,4,3] };

// ====================== ZMIENNE ======================
let tiles=[], inventory=[], score=0, lastTime=0;

// ====================== GENERATOR ======================
// Tworzy kafelki w warstwach, zawsze grywalne
function build(layers){
  const size=Math.min(innerWidth,innerHeight)*0.85;
  const max=layers[0];
  const tileSize=size/max;
  let img=1, color=0;

  board.style.width=size+"px"; board.style.height=size+"px";

  layers.forEach((n,z)=>{
    const off=(max-n)/2*tileSize;
    const shape=getShape(n); // losuje jeden z 7 stabilnych kształtów

    for(let y=0;y<shape.h;y++){
      for(let x=0;x<shape.w;x++){
        // Każdy kafelek z obrazem i kolorem
        const t=document.createElement("div"); t.className="tile";
        t.style.width=tileSize+"px"; t.style.height=tileSize+"px";
        t.style.left=off+x*tileSize+"px"; t.style.top=off+y*tileSize+"px";
        t.style.border="4px solid "+COLORS[color%COLORS.length];
        t.dataset.img=img; t.dataset.color=COLORS[color%COLORS.length]; t.dataset.z=z;

        const im=document.createElement("img"); im.src=`assets/images/${img}.png`;
        t.appendChild(im);

        t.onclick=()=>clickTile(t);

        board.appendChild(t);
        tiles.push(t);

        img++; if(img>16) img=1;
        color++;
      }
    }
  });

  // Po utworzeniu warstw oznaczamy wolne kafelki
  updateFree();
}

// ====================== KLIK ======================
function clickTile(t){
  if(t.classList.contains("blocked")) return; // tylko wolne
  document.getElementById("click").play(); // dźwięk kliknięcia
  inventory.push({img:t.dataset.img,color:t.dataset.color});
  tiles.splice(tiles.indexOf(t),1); t.remove();
  updateFree(); renderInv();

  if(inventory.length===4) checkInv(); // sprawdzamy ekwipunek
}

// ====================== AKTUALIZACJA WOLNYCH ======================
function updateFree(){
  tiles.forEach(t=>{
    const z=+t.dataset.z;
    const blocked=tiles.some(o=>o!==t && +o.dataset.z>z && overlap(t,o));
    t.className="tile "+(blocked?"blocked":"free");
  });
}

function overlap(a,b){
  const A=a.getBoundingClientRect(), B=b.getBoundingClientRect();
  return !(A.right<=B.left||A.left>=B.right||A.bottom<=B.top||A.top>=B.bottom);
}

// ====================== EKWIPUNEK ======================
function renderInv(){
  invEl.innerHTML="";
  inventory.forEach(i=>{
    const d=document.createElement("div"); d.className="inv";
    const im=document.createElement("img"); im.src=`assets/images/${i.img}.png`;
    d.appendChild(im); invEl.appendChild(d);
  });
}

function checkInv(){
  const [a,b,c,d]=inventory;
  // PARA tylko jeśli obraz i kolor identyczny
  const ok=(a.img===b.img && b.img===c.img && c.img===d.img &&
            a.color===b.color && b.color===c.color && c.color===d.color);
  const dt=(performance.now()-lastTime)/1000;
  lastTime=performance.now();

  if(ok){
    document.getElementById("pair").play(); // dźwięk pary
    addScore(dt);
  }
  inventory=[]; renderInv();
}

// ====================== SCORE ======================
function addScore(dt){
  let pts=50,msg="good";
  if(dt<=1.4){pts=500;msg="you are the legend!";}
  else if(dt<=3.5){pts=350;msg="its impossible!";}
  else if(dt<=5){pts=250;msg="insane";}
  else if(dt<=7.5){pts=150;msg="awesome";}
  else if(dt<=10){pts=100;msg="nice";}
  score+=pts; animateScore(msg,pts);
}

function animateScore(msg,pts){
  msgEl.innerText=msg;
  let start=score-pts, end=score, duration=300, startTime=null;
  function step(timestamp){
    if(!startTime) startTime=timestamp;
    let progress=(timestamp-startTime)/duration;
    if(progress>1) progress=1;
    scoreEl.innerText="Score: "+Math.floor(start + (end-start)*progress);
    if(progress<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

