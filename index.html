<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mahjong Neon – Final Stable</title>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#2f241b;
  font-family:Arial,sans-serif;
}
#game{position:relative;width:100%;height:100%;}
.tile{
  position:absolute;
  background:white;
  border-radius:10px;
  box-sizing:border-box;
  transition:.15s;
}
.tile.free{
  box-shadow:0 0 15px currentColor;
  cursor:pointer;
}
.tile.locked{
  opacity:.45;
  filter:grayscale(80%);
}
.tile img{width:100%;height:100%;object-fit:contain;pointer-events:none;}

#inventory{
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:10px;
}
.inv{
  width:60px;height:60px;
  background:#eee;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.inv img{width:90%;height:90%;}

#ui{
  position:absolute;
  top:10px;
  left:10px;
  color:white;
  font-size:16px;
}
#popup{
  position:absolute;
  top:45%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:36px;
  font-weight:bold;
  opacity:0;
  pointer-events:none;
  transition:.3s;
  text-shadow:0 0 20px black;
}
#popup.show{opacity:1;transform:translate(-50%,-60%);}

#menu{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:12px;
  z-index:10;
}
.menu-btn{
  padding:14px 26px;
  font-size:22px;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
.score-fly{
  position:absolute;
  font-size:22px;
  color:yellow;
  animation:fly .8s forwards;
  pointer-events:none;
}
@keyframes fly{
  to{transform:translateY(-60px);opacity:0;}
}
</style>
</head>

<body>
<div id="game"></div>
<div id="popup"></div>

<div id="inventory">
  <div class="inv"></div><div class="inv"></div><div class="inv"></div><div class="inv"></div>
</div>

<div id="ui">
  Score: <span id="score">0</span><br>
  Time: <span id="time">0.0</span>s
</div>

<div id="menu">
  <button class="menu-btn" data-layers="3,2">Łatwy</button>
  <button class="menu-btn" data-layers="4,3,2">Średni</button>
  <button class="menu-btn" data-layers="5,4,3,2">Trudny</button>
  <button class="menu-btn" data-layers="6,5,4,3">Ekstremalny</button>
  <button class="menu-btn" data-layers="7,6,5,4,3">Zawodowy</button>
</div>

<script>
/* ===== GEOMETRIA – NIETYKALNA ===== */
function computeTileSize(layers,w,h,p=20){
  const max=Math.max(...layers);
  return Math.floor(Math.min((w-p*2)/max,(h-p*2)/max));
}
function computeLayouts(layers,t,w,h){
  const cx=w/2, cy=h/2;
  return layers.map((s,z)=>({
    z,s,
    x0:cx-(s*t)/2,
    y0:cy-(s*t)/2
  }));
}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

/* ===== GAME STATE ===== */
const colors=["#ff0033","#00e5ff","#ffee00","#00ff55","#ff00ff","#ff8800","#00ffaa","#8888ff"];
let layers=[], tiles=[], inventory=[], score=0, lastTime=Date.now();

const game=document.getElementById("game");
const popup=document.getElementById("popup");

/* ===== UTILS ===== */
function wood(){
  const a=new AudioContext();
  const o=a.createOscillator(), g=a.createGain();
  o.frequency.value=160;o.type="triangle";
  g.gain.value=.25;
  o.connect(g);g.connect(a.destination);
  o.start();g.gain.exponentialRampToValueAtTime(.001,a.currentTime+.15);
  o.stop(a.currentTime+.15);
}
function scoreByTime(){
  const d=(Date.now()-lastTime)/1000; lastTime=Date.now();
  if(d<=1.4)return [500,"YOU ARE THE LEGEND!"];
  if(d<=3.5)return [350,"IT'S IMPOSSIBLE!"];
  if(d<=5)return [250,"INSANE"];
  if(d<=7.5)return [150,"AWESOME"];
  if(d<=10)return [100,"NICE"];
  return [50,"GOOD"];
}

/* ===== LOGIKA MAHJONGA ===== */
function isFree(t){
  const left=tiles.some(o=>!o.removed&&o.z===t.z&&o.x===t.x-1&&o.y===t.y);
  const right=tiles.some(o=>!o.removed&&o.z===t.z&&o.x===t.x+1&&o.y===t.y);
  const above=tiles.some(o=>!o.removed&&o.z>t.z&&o.x===t.x&&o.y===t.y);
  return !(left&&right) && !above;
}

/* ===== GENERATE ===== */
function generate(){
  tiles=[];inventory=[];score=0;lastTime=Date.now();
  const total=layers.reduce((a,s)=>a+s*s,0);
  let pool=[];
  let img=1,col=0;
  while(pool.length<total){
    pool.push({img,col});pool.push({img,col});
    col++;if(col>=colors.length){col=0;img++;if(img>16)img=1;}
  }
  pool.sort(()=>Math.random()-.5);
  let i=0;
  layers.forEach((s,z)=>{
    for(let y=0;y<s;y++)for(let x=0;x<s;x++){
      const p=pool[i++];
      tiles.push({x,y,z,img:p.img,color:colors[p.col],removed:false});
    }
  });
  ensurePlayable();
  render();
}

/* ===== ENSURE PLAYABLE ===== */
function ensurePlayable(){
  for(let k=0;k<200;k++){
    const free=tiles.filter(t=>!t.removed&&isFree(t));
    for(let i=0;i<free.length;i++)
      for(let j=i+1;j<free.length;j++)
        if(free[i].img===free[j].img&&free[i].color===free[j].color)
          return;
    shuffle();
  }
}
function shuffle(){
  const a=tiles.filter(t=>!t.removed);
  const d=a.map(t=>({img:t.img,color:t.color})).sort(()=>Math.random()-.5);
  a.forEach((t,i)=>{t.img=d[i].img;t.color=d[i].color;});
}

/* ===== SELECT ===== */
function select(t){
  if(!isFree(t))return;
  inventory.push(t);t.removed=true;
  for(let i=0;i<inventory.length;i++)
    for(let j=i+1;j<inventory.length;j++)
      if(inventory[i].img===inventory[j].img&&inventory[i].color===inventory[j].color){
        inventory.splice(j,1);inventory.splice(i,1);
        const [pts,txt]=scoreByTime();
        score+=pts;wood();
        popup.textContent=txt;popup.classList.add("show");
        setTimeout(()=>popup.classList.remove("show"),700);
        render();return;
      }
  if(inventory.length>=4){alert("Ekwipunek pełny");generate();}
  render();
}

/* ===== RENDER ===== */
function render(){
  game.innerHTML="";
  const w=innerWidth,h=innerHeight*.8;
  const ts=computeTileSize(layers,w,h);
  const layouts=computeLayouts(layers,ts,w,h);

  layouts.forEach(l=>{
    tiles.filter(t=>t.z===l.z&&!t.removed).forEach(t=>{
      const d=document.createElement("div");
      d.className="tile "+(isFree(t)?"free":"locked");
      d.style.width=d.style.height=ts+"px";
      d.style.color=t.color;
      d.style.border="4px solid "+t.color;
      d.style.left=clamp(l.x0+t.x*ts,0,w-ts)+"px";
      d.style.top=clamp(l.y0+t.y*ts,0,h-ts)+"px";
      d.style.zIndex=100+t.z;
      if(isFree(t))d.onclick=()=>select(t);
      const img=document.createElement("img");
      img.src=`assets/images/${t.img}.png`;
      d.appendChild(img);
      game.appendChild(d);
    });
  });

  document.querySelectorAll(".inv").forEach((s,i)=>{
    s.innerHTML="";
    if(inventory[i]){
      const im=document.createElement("img");
      im.src=`assets/images/${inventory[i].img}.png`;
      s.appendChild(im);
    }
  });

  document.getElementById("score").textContent=score;
}

/* ===== MENU ===== */
document.querySelectorAll(".menu-btn").forEach(b=>{
  b.onclick=()=>{
    layers=b.dataset.layers.split(",").map(Number);
    document.getElementById("menu").style.display="none";
    generate();
  };
});
window.onresize=render;
setInterval(()=>document.getElementById("time").textContent=((Date.now()-lastTime)/1000).toFixed(1),100);
</script>
</body>
</html>

