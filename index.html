<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mahjong Pyramid FINAL</title>
<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(rgba(0,0,0,.5),rgba(0,0,0,.5)),
  url('https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1400');
  background-size:cover;
  background-position:center;
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
}
#menu,#game{ width:100%; text-align:center; }
#menu button{
  margin:8px; padding:14px 24px; font-size:1rem;
  border:none; border-radius:10px; background:#222; color:#fff; cursor:pointer;
}
#menu button:hover{ background:#00e5ff; color:#000; }
.board{
  position:relative;
  width:95vmin;
  height:95vmin;
  margin:20px auto;
}
.tile{
  position:absolute;
  border-radius:10px;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#fff;
  transition:.25s ease;
}
.tile img{ width:80%; height:80%; object-fit:contain; }
.tile:hover{ transform:scale(1.07); box-shadow:0 0 25px currentColor; }
.tile.blocked{ opacity:.5; cursor:not-allowed; }
#inventory{ display:flex; justify-content:center; gap:10px; margin-bottom:30px; }
.slot{
  width:60px; height:60px; background:#fff;
  border:3px solid #00e5ff; border-radius:8px;
  display:flex; justify-content:center; align-items:center;
}
#score{ font-size:1.3rem; margin-top:10px; }
</style>
</head>
<body>

<div id="menu">
<h1>Mahjong Pyramid</h1>
<button data-level="pro">Zawodowy</button>
<button data-level="extreme">Ekstremalny</button>
<button data-level="hard">Trudny</button>
<button data-level="medium">Średni</button>
<button data-level="classic">Klasyczny</button>
<button data-level="easy">Łatwy</button>
</div>

<div id="game" style="display:none;">
<div id="score">Score: 0</div>
<div class="board" id="board"></div>
<div id="inventory">
<div class="slot"></div><div class="slot"></div>
<div class="slot"></div><div class="slot"></div>
</div>
</div>

<script>
const levels={
  pro:[7,6,5,4,3],
  extreme:[6,5,4,3],
  hard:[5,4,3,2],
  medium:[4,3,2],
  easy:[3,2]
};

const colors=["#ff3b3b","#00e5ff","#ffff00","#00ff6a","#ff00ff","#ff8800","#0088ff","#7dff00"];

let board=document.getElementById("board");
let slots=document.querySelectorAll(".slot");
let scoreEl=document.getElementById("score");
let currentLevel=null;
let tilesData=[];
let inventory=[];
let score=0;

// PRELOAD 1-16 PNG
let preloadPromises=[];
for(let i=1;i<=16;i++){
  preloadPromises.push(new Promise(res=>{
    let img=new Image();
    img.src=`assets/images/${i}.png`;
    img.onload=res; img.onerror=res;
  }));
}

Promise.all(preloadPromises).then(()=>{
  document.querySelectorAll("#menu button").forEach(btn=>{
    btn.onclick=()=>{
      currentLevel=btn.dataset.level;
      document.getElementById("menu").style.display="none";
      document.getElementById("game").style.display="block";
      setTimeout(()=>startGame(currentLevel),50);
    }
  });
});

window.addEventListener("resize",()=>{
  if(currentLevel) startGame(currentLevel);
});

function startGame(level){
  board.innerHTML="";
  inventory=[];
  tilesData=[];
  score=0;
  scoreEl.innerText="Score: 0";
  slots.forEach(s=>s.innerHTML="");

  let layers = level==="classic" ? randomLayers() : levels[level];

  let totalTiles = layers.reduce((sum,l)=>sum+l*l,0);
  if(level==="pro") totalTiles=128; // dokładnie 128
  if(totalTiles%2!==0) totalTiles--;

  let maxSize=Math.max(...layers);
  let tileSize=Math.floor(board.clientWidth/(maxSize+1));

  let pairCount=totalTiles/2;
  let pairs=[];
  for(let i=0;i<pairCount;i++){
    let imgIndex=(i%16)+1;
    let color=colors[i%8];
    pairs.push({id:i,img:imgIndex,color});
    pairs.push({id:i,img:imgIndex,color});
  }
  pairs.sort(()=>Math.random()-0.5);

  let index=0;
  layers.forEach((size,layerIndex)=>{
    let offsetX=(board.clientWidth-size*tileSize)/2;
    let offsetY=layerIndex*(tileSize/2);

    for(let r=0;r<size;r++){
      for(let c=0;c<size;c++){
        if(index>=pairs.length) return;
        let p=pairs[index];
        let div=document.createElement("div");
        div.className="tile";
        div.style.width=tileSize+"px";
        div.style.height=tileSize+"px";
        div.style.left=(offsetX+c*tileSize)+"px";
        div.style.top=(offsetY+r*tileSize)+"px";
        div.style.border="4px solid "+p.color;
        div.style.color=p.color;
        div.dataset.id=p.id;
        div.dataset.layer=layerIndex;
        div.innerHTML=`<img src='assets/images/${p.img}.png'>`;
        div.onclick=()=>pick(div);
        board.appendChild(div);
        tilesData.push(div);
        index++;
      }
    }
  });
  updateBlocked();
}

function randomLayers(){
  let count=Math.floor(Math.random()*3)+2;
  let arr=[];
  for(let i=0;i<count;i++) arr.push(Math.floor(Math.random()*5)+2);
  return arr;
}

function updateBlocked(){
  tilesData.forEach(t=>{
    t.classList.remove("blocked");
    let layer=parseInt(t.dataset.layer);
    let rect=t.getBoundingClientRect();
    for(let other of tilesData){
      if(other===t) continue;
      if(parseInt(other.dataset.layer)>layer && other.style.visibility!=="hidden"){
        let r2=other.getBoundingClientRect();
        if(!(rect.right<r2.left||rect.left>r2.right||rect.bottom<r2.top||rect.top>r2.bottom)){
          t.classList.add("blocked");
        }
      }
    }
  });
}

function pick(tile){
  if(tile.classList.contains("blocked")) return;
  if(inventory.length>=4){ alert("Ekwipunek pełny — reset"); startGame(currentLevel); return; }

  tile.style.visibility="hidden";
  inventory.push(tile);
  slots[inventory.length-1].innerHTML=tile.innerHTML;
  checkMatch();
  updateBlocked();
}

function checkMatch(){
  for(let i=0;i<inventory.length;i++){
    for(let j=i+1;j<inventory.length;j++){
      if(inventory[i].dataset.id===inventory[j].dataset.id){
        inventory[i].remove();
        inventory[j].remove();
        inventory=[];
        slots.forEach(s=>s.innerHTML="");
        score+=200;
        scoreEl.innerText="Score: "+score;
        updateBlocked();
        return;
      }
    }
  }
}
</script>
</body>
</html>
