<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mahjong Neon Premium</title>
<style>
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;font-family:Arial,sans-serif;background:#3b2a1d;}
#game{position:relative;width:100%;height:100%;background:url('assets/images/wood-bg.jpg') center/cover no-repeat;}
.tile{position:absolute;border-radius:12px;background:white;cursor:pointer;transition:all .3s ease;box-sizing:border-box;box-shadow:0 0 5px #000;}
.tile img{width:100%;height:100%;object-fit:contain;pointer-events:none;}
.tile.free{box-shadow:0 0 20px #0ff,0 0 10px #0ff inset; transform:scale(1.05);}
.tile.locked{opacity:0.5;filter:grayscale(70%);}
#inventory{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:12px;}
.inv-slot{width:70px;height:70px;background:#fafafa;border-radius:12px;box-shadow:0 0 10px #000;display:flex;align-items:center;justify-content:center;}
.inv-slot img{width:90%;height:90%;}
#ui{position:absolute;top:10px;left:10px;color:white;font-size:18px;text-shadow:0 0 5px black;}
#comboDisplay{display:inline-block;transition:transform .3s,color .3s;font-weight:bold;}
#popup{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:38px;font-weight:bold;color:white;text-shadow:0 0 20px black;opacity:0;pointer-events:none;transition:opacity .3s, transform .3s;}
#popup.show{opacity:1;transform:translate(-50%,-60%);}
#menu{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;font-size:28px;z-index:100;}
.menu-btn{margin:10px;padding:14px 28px;background:#222;border:none;border-radius:12px;color:white;font-size:24px;cursor:pointer;transition:all .2s;}
.menu-btn:hover{background:#444;}
.score-fly{position:absolute;font-weight:bold;color:yellow;font-size:24px;text-shadow:0 0 6px black;pointer-events:none;animation:flyup .8s forwards;}
@keyframes flyup{0%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-60px);}}
.score-fly-multiplier{position:absolute;font-weight:bold;color:#ff0;font-size:28px;text-shadow:0 0 10px black;pointer-events:none;animation:flymult .8s forwards;}
@keyframes flymult{0%{opacity:1;transform:scale(1) translateY(0);}100%{opacity:0;transform:scale(1.5) translateY(-60px);}}
.particle{position:absolute;width:8px;height:8px;border-radius:50%;pointer-events:none;animation:particleFly 0.6s forwards;}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0);}100%{opacity:0;transform:translate(var(--x),var(--y)) scale(0);}}
</style>
</head>
<body>

<div id="game"></div>
<div id="popup"></div>

<div id="inventory">
  <div class="inv-slot"></div>
  <div class="inv-slot"></div>
  <div class="inv-slot"></div>
  <div class="inv-slot"></div>
</div>

<div id="ui">
  Score: <span id="score">0</span><br>
  Combo: <span id="comboDisplay">1</span><br>
  Time: <span id="time">0.0</span>s
</div>

<div id="menu">
  <div>Wybierz poziom:</div>
  <button class="menu-btn" data-level="latwy">Łatwy</button>
  <button class="menu-btn" data-level="klasyczny">Klasyczny</button>
  <button class="menu-btn" data-level="sredni">Średni</button>
  <button class="menu-btn" data-level="trudny">Trudny</button>
  <button class="menu-btn" data-level="ekstremalny">Ekstremalny</button>
  <button class="menu-btn" data-level="zawodowy">Zawodowy</button>
</div>

<script>
// ===== CONFIG =====
const levelsData={
  latwy:[3,2],
  klasyczny:[4,3,2],
  sredni:[4,3,2],
  trudny:[5,4,3,2],
  ekstremalny:[6,5,4,3],
  zawodowy:[7,6,5,4,3]
};
const colors=["#ff0033","#00e5ff","#ffee00","#00ff55","#ff00ff","#00ffaa","#ff8800","#8888ff"];

let layers=[], board=[], inventory=[], score=0, combo=1, lastPairTime=Date.now(), tileSize=100;

// ===== ELEMENTS =====
const game=document.getElementById("game");
const scoreSpan=document.getElementById("score");
const comboDisplay=document.getElementById("comboDisplay");
const timeSpan=document.getElementById("time");
const popup=document.getElementById("popup");
const menu=document.getElementById("menu");

// ===== PRELOAD IMAGES =====
for(let i=1;i<=16;i++){let img=new Image(); img.src=`assets/images/${i}.png`;}

// ===== SOUND =====
function woodSound(){
  const ctx=new AudioContext();
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.type="triangle"; o.frequency.value=180;
  g.gain.setValueAtTime(0.25,ctx.currentTime);
  o.connect(g); g.connect(ctx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.15);
  o.stop(ctx.currentTime+0.15);
}

// ===== SCORE & POPUP =====
function getScoreByTime(){
  const diff=(Date.now()-lastPairTime)/1000;
  lastPairTime=Date.now();
  if(diff<=1.4){showText("YOU ARE THE LEGEND!","#ff00ff"); return 500;}
  if(diff<=3.5){showText("IT'S IMPOSSIBLE!","#00e5ff"); return 350;}
  if(diff<=5.0){showText("INSANE","#ff0033"); return 250;}
  if(diff<=7.5){showText("AWESOME","#ffee00"); return 150;}
  if(diff<=10){showText("NICE","#00ff55"); return 100;}
  showText("GOOD","#ffffff"); return 50;
}
function showText(txt,color){
  popup.textContent=txt;
  popup.style.color=color;
  popup.classList.add("show");
  setTimeout(()=>popup.classList.remove("show"),800);
}

// ===== GAME LOGIC =====
function generate(){
  board=[]; inventory=[]; score=0; combo=1; lastPairTime=Date.now();
  const maxLayer = Math.max(...layers);
  const total=layers.reduce((a,b)=>a+b*b,0);
  let pool=[], imgIndex=1, colorIndex=0;
  while(pool.length<total){
    pool.push({img:imgIndex,color:colorIndex});
    pool.push({img:imgIndex,color:colorIndex});
    colorIndex++; if(colorIndex>=colors.length){colorIndex=0; imgIndex++; if(imgIndex>16) imgIndex=1;}
  }
  pool.sort(()=>Math.random()-0.5);
  let idx=0;
  layers.forEach((size,z)=>{
    for(let y=0;y<size;y++){
      for(let x=0;x<size;x++){
        board.push({x,y,z,img:pool[idx].img,color:colors[pool[idx].color],removed:false,animating:false});
        idx++;
      }
    }
  });
  ensurePlayable();
  render();
}

function isFree(t){
  if(t.removed||t.animating) return false;
  const left=board.some(o=>!o.removed&&o.z===t.z&&o.x===t.x-1&&o.y===t.y);
  const right=board.some(o=>!o.removed&&o.z===t.z&&o.x===t.x+1&&o.y===t.y);
  return !(left&&right);
}

function select(tile){
  if(tile.animating||!isFree(tile)) return;
  tile.animating=true;
  const tileEl=document.querySelectorAll(".tile")[board.indexOf(tile)];
  const invRect=document.querySelectorAll(".inv-slot")[inventory.length].getBoundingClientRect();
  tileEl.style.transition="all .4s ease";
  tileEl.style.left=invRect.left+"px"; tileEl.style.top=invRect.top+"px"; tileEl.style.transform="scale(0.5)";
  setTimeout(()=>{
    inventory.push(tile); tile.removed=true; tile.animating=false;
    for(let i=0;i<inventory.length;i++){
      for(let j=i+1;j<inventory.length;j++){
        if(inventory[i].img===inventory[j].img && inventory[i].color===inventory[j].color){
          inventory.splice(j,1); inventory.splice(i,1);
          const gained=getScoreByTime(); score+=gained*combo; combo++;
          comboDisplay.textContent=combo;
          comboDisplay.style.transform="scale(1.5)";
          comboDisplay.style.color=colors[combo%colors.length];
          createFlyingMultiplier("x"+combo,invRect.left,invRect.top);
          createFlyingParticles(invRect.left,invRect.top);
          setTimeout(()=>{comboDisplay.style.transform="scale(1)"; comboDisplay.style.color="white";},300);
          createFlyingScore("+"+(gained*combo),invRect.left,invRect.top);
          woodSound();
          render();
          return;
        }
      }
    }
    if(inventory.length>=4){alert("Ekwipunek pełny!"); generate(); return;}
    if(board.every(t=>t.removed)){alert("WYGRANA! SCORE: "+score); generate(); return;}
    render();
  },400);
}

// ===== ENSURE PLAYABLE =====
function hasPlayablePair(){
  const free=board.filter(t=>isFree(t));
  for(let i=0;i<free.length;i++){for(let j=i+1;j<free.length;j++){if(free[i].img===free[j].img && free[i].color===free[j].color) return true;}}
  return false;
}
function shuffle(){
  const active=board.filter(t=>!t.removed);
  const data=active.map(t=>({img:t.img,color:t.color})).sort(()=>Math.random()-0.5);
  active.forEach((t,i)=>{t.img=data[i].img; t.color=data[i].color;});
}
function ensurePlayable(){let attempts=0; while(!hasPlayablePair()&&attempts<200){shuffle(); attempts++;}}

// ===== EFFECTS =====
function createFlyingScore(text,x,y){const el=document.createElement("div"); el.className="score-fly"; el.style.left=x+"px"; el.style.top=y+"px"; el.textContent=text; game.appendChild(el); setTimeout(()=>el.remove(),800);}
function createFlyingMultiplier(text,x,y){const el=document.createElement("div"); el.className="score-fly-multiplier"; el.style.left=x+"px"; el.style.top=y+"px"; el.textContent=text; game.appendChild(el); setTimeout(()=>el.remove(),800);}
function createFlyingParticles(x,y){
  for(let i=0;i<12;i++){
    const p=document.createElement("div"); p.className="particle";
    const angle=Math.random()*2*Math.PI;
    const radius=50+Math.random()*20;
    p.style.left=x+"px"; p.style.top=y+"px";
    p.style.setProperty('--x', radius*Math.cos(angle)+'px');
    p.style.setProperty('--y', radius*Math.sin(angle)+'px');
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    game.appendChild(p);
    setTimeout(()=>p.remove(),600);
  }
}

// ===== RENDER =====
function render(){
  document.querySelectorAll(".tile").forEach(e=>e.remove());
  const maxLayer=Math.max(...layers);
  const screenW=window.innerWidth, screenH=window.innerHeight*0.8;
  tileSize=Math.floor(Math.min(screenW/maxLayer,screenH/maxLayer));
  const offsetX=(screenW-tileSize*maxLayer)/2, offsetY=(screenH-tileSize*maxLayer)/2;
  board.forEach(t=>{
    if(t.removed) return;
    const d=document.createElement("div");
    d.className="tile "+(isFree(t)?"free":"locked");
    d.style.width=d.style.height=tileSize+"px";
    d.style.border="4px solid "+t.color;
    d.style.left=offsetX + (t.x+(maxLayer-t.z)/2)*tileSize+"px";
    d.style.top=offsetY + (t.y+(maxLayer-t.z)/2)*tileSize+"px";
    const img=document.createElement("img"); img.src=`assets/images/${t.img}.png`; d.appendChild(img);
    if(isFree(t)) d.onclick=()=>select(t);
    game.appendChild(d);
  });
  document.querySelectorAll(".inv-slot").forEach((s,i)=>{s.innerHTML=""; if(inventory[i]){const img=document.createElement("img"); img.src=`assets/images/${inventory[i].img}.png`; s.appendChild(img);}});
  scoreSpan.textContent=score;
}

// ===== TIMER =====
setInterval(()=>{timeSpan.textContent=((Date.now()-lastPairTime)/1000).toFixed(1);},100);

// ===== MENU =====
document.querySelectorAll(".menu-btn").forEach(btn=>{btn.onclick=()=>{layers=levelsData[btn.dataset.level]; menu.style.display="none"; generate();}});

window.onresize=render;

</script>
</body>
</html>

